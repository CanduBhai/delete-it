#!/bin/bash

BASE_DIR="values"

# cuat ‚Üí prod mapping
declare -A cuat_to_prod
cuat_to_prod["z1.values.yaml"]="cuat1:prod1"
cuat_to_prod["z2.values.yaml"]="cuat3:prod3"
cuat_to_prod["z3.values.yaml"]="cuat12:prod12"

# Loop through each file
find "$BASE_DIR" -type f -name "z*.values.yaml" | while read -r file; do
  filename=$(basename "$file")
  mapping=${cuat_to_prod[$filename]}

  if [ -z "$mapping" ]; then
    echo "‚ùå No mapping for $filename. Skipping..."
    continue
  fi

  cuat=${mapping%%:*}
  prod=${mapping##*:}
  echo "üîß Processing $filename ‚Äî Replacing $cuat ‚Üê $prod"

  awk -v cuat="$cuat" -v prod="$prod" '
    BEGIN { section = "" }

    /^[^[:space:]]/ { section = $1 }

    {
      if ($1 == prod ":") {
        prodval[section] = $2
      }
      lines[NR] = $0
      keys[NR] = $1
      sections[NR] = section
    }

    END {
      for (i = 1; i <= NR; i++) {
        if (keys[i] == cuat ":") {
          if (prodval[sections[i]] != "") {
            printf("  %s: %s\n", cuat, prodval[sections[i]])
            continue
          }
        }
        print lines[i]
      }
    }
  ' "$file" > "$file.tmp" && mv "$file.tmp" "$file"

done

echo "‚úÖ Done! cuat values updated from prod values."
